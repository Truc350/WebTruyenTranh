<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chat Ng∆∞·ªùi B√°n - Ng∆∞·ªùi Mua</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="../css/adminCss/chatWithCus.css">
    <link rel="stylesheet" href="../css/adminCss/adminHeader.css">
    <link rel="stylesheet" href="../css/adminCss/styleSidebar.css">
</head>
<body>
<div class="container">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="../../img/logo.png" alt="Logo" class="logo">
            <h2>Comic Store</h2>
        </div>

        <ul>
            <li>
                <a href="dashboard.html">
                    <img src="../../img/home.png" class="icon">
                    <span>Trang ch·ªß</span>
                </a>
            </li>
            <li>
                <a href="productManagement.html">
                    <img src="../../img/product.png" class="icon">
                    <span>Qu·∫£n l√Ω s·∫£n ph·∫©m</span>
                </a>
            </li>
            <li>
                <a href="category.html">
                    <img src="../../img/category.png" class="icon">
                    <span>Qu·∫£n l√Ω th·ªÉ lo·∫°i</span>
                </a>
            </li>
            <li>
                <a href="order.html">
                    <img src="../../img/order.png" class="icon">
                    <span>Qu·∫£n l√Ω ƒë∆°n h√†ng</span>
                </a>
            </li>
            <li>
                <a href="userManagement.html">
                    <img src="../../img/user.png" class="icon">
                    <span>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span>
                </a>
            </li>
            <li>
                <a href="promotion.html">
                    <img src="../../img/promo.png" class="icon">
                    <span>Qu·∫£n l√Ω khuy·∫øn m√£i</span>
                </a>
            </li>
            <li>
                <a href="report.html">
                    <img src="../../img/report.png" class="icon">
                    <span>Th·ªëng k√™</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- Main content -->
    <div class="main-content">
        <header class="admin-header">
            <div class="header-right">
                <a href="chatWithCus.html">
                    <i class="fa-solid fa-comment"></i>
                </a>

                <div class="admin-profile">
                    <a href="profileAdmin.html">
                        <img src="../../img/admin.png" class="admin-avatar" alt="Admin">
                    </a>
                    <span class="admin-name">Admin</span>
                </div>

                <!-- N√∫t ƒëƒÉng xu·∫•t -->
                <button class="btn-logout" title="ƒêƒÉng xu·∫•t">
                    <a href="../public/login.html">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </a>
                </button>
            </div>
        </header>

        <!-- ==================== CHAT ==================== -->
        <div class="chat-container">

            <!-- Danh s√°ch kh√°ch h√†ng -->
            <div class="user-list">
                <div class="user-list-header">Kh√°ch h√†ng</div>
                <ul id="userList">
                    <li data-user-id="1" onclick="selectUser(1)" class="active">
                        <img src="https://i.pravatar.cc/150?img=12" alt="User 1" class="user-avatar">
                        <div class="user-info">
                            <div class="user-name">Tr√¢m Nguy·ªÖn</div>
                            <div class="user-preview">Shop ∆°i, b·ªô One Piece t·∫≠p 107 c√≤n h√†ng kh√¥ng ·∫°?</div>
                        </div>
                        <div class="user-status online"></div>
                        <span class="unread-badge">1</span>
                    </li>
                    <li data-user-id="2" onclick="selectUser(2)">
                        <img src="https://i.pravatar.cc/150?img=15" alt="User 2" class="user-avatar">
                        <div class="user-info">
                            <div class="user-name">Minh Anh</div>
                            <div class="user-preview">B·ªô Naruto b·∫£n ƒë·∫∑c bi·ªát khi n√†o c√≥ h√†ng l·∫°i v·∫≠y?</div>
                        </div>
                        <div class="user-status"></div>
                    </li>
                </ul>
            </div>

            <!-- Khu v·ª±c chat -->
            <div class="chat-area">
                <div class="chat-header" id="chatHeader">
                    <img src="https://i.pravatar.cc/150?img=12" alt="" class="user-avatar">
                    <div class="header-info">
                        <h3>Tr√¢m Nguy·ªÖn</h3>
                        <small><i class="fas fa-circle online-dot"></i> ƒêang ho·∫°t ƒë·ªông</small>
                    </div>
                    <button class="header-action"><i class="fas fa-ellipsis-v"></i></button>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message received">
                        <div class="bubble">Shop ∆°i, b·ªô One Piece t·∫≠p 107 c√≤n h√†ng kh√¥ng ·∫°?</div>
                        <div class="timestamp">10:32</div>
                    </div>
                    <div class="message sent">
                        <div class="bubble">Ch√†o b·∫°n, One Piece t·∫≠p 107 hi·ªán c√≤n h√†ng nh√© üòä</div>
                        <div class="timestamp">10:33</div>
                    </div>
                </div>

                <!-- Typing indicator -->
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <span></span><span></span><span></span>
                </div>

                <!-- Nh·∫≠p tin -->
                <div class="chat-input">
                    <label class="input-action" for="imageInput" title="G·ª≠i ·∫£nh">
                        <i class="fas fa-image"></i>
                    </label>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;"/>
                    <textarea id="messageInput" placeholder="Nh·∫≠p n·ªôi dung tr·∫£ l·ªùi..." rows="1"></textarea>
                    <button class="input-action emoji-btn"><i class="fas fa-smile"></i></button>
                    <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>

                <!-- Xem tr∆∞·ªõc ·∫£nh -->
                <div id="imagePreview" class="image-preview" style="display: none;">
                    <img id="previewImg" src="" alt="Preview"/>
                    <button class="close-preview" onclick="closePreview()">√ó</button>
                    <button class="send-image-btn" onclick="sendImage()">G·ª≠i</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== SCRIPT ==================== -->
<script>
    const STORAGE_KEY = 'seller_chat_history';
    let conversations = {};

    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) conversations = JSON.parse(saved);
    } catch (e) {
        console.warn("Kh√¥ng th·ªÉ ƒë·ªçc d·ªØ li·ªáu:", e);
    }

    // D·ªØ li·ªáu m·∫∑c ƒë·ªãnh
    const defaultConversations = {
        1: {
            user: {name: "Tr√¢m Nguy·ªÖn", avatar: "https://i.pravatar.cc/150?img=12", online: true},
            messages: [
                {text: "Shop ∆°i, b·ªô One Piece t·∫≠p 107 c√≤n h√†ng kh√¥ng ·∫°?", type: "received", time: "10:32"},
                {text: "Ch√†o b·∫°n, One Piece t·∫≠p 107 hi·ªán c√≤n h√†ng nh√© üòä", type: "sent", time: "10:33"}
            ]
        },
        2: {
            user: {name: "Minh Anh", avatar: "https://i.pravatar.cc/150?img=15", online: false},
            messages: [
                {text: "B·ªô Naruto b·∫£n ƒë·∫∑c bi·ªát khi n√†o c√≥ h√†ng l·∫°i v·∫≠y?", type: "received", time: "09:15"},
                {text: "B·ªô Naruto b·∫£n ƒë·∫∑c bi·ªát d·ª± ki·∫øn v·ªÅ h√†ng v√†o tu·∫ßn sau ·∫°.", type: "sent", time: "09:16"}
            ]
        }
    };

    Object.keys(defaultConversations).forEach(id => {
        if (!conversations[id]) conversations[id] = defaultConversations[id];
    });

    let currentUserId = 1;

    function saveToStorage() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
        } catch (e) {
            console.warn("Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu:", e);
        }
    }

    function loadConversation(userId) {
        const conv = conversations[userId];
        const header = document.getElementById('chatHeader');
        const messagesDiv = document.getElementById('chatMessages');

        header.innerHTML = `
            <img src="${conv.user.avatar}" alt="" class="user-avatar">
            <div class="header-info">
                <h3>${conv.user.name}</h3>
                <small><i class="fas fa-circle online-dot"></i> ${conv.user.online ? 'ƒêang ho·∫°t ƒë·ªông' : 'Offline'}</small>
            </div>
            <button class="header-action"><i class="fas fa-ellipsis-v"></i></button>
        `;

        messagesDiv.innerHTML = '';
        conv.messages.forEach(msg => {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${msg.type}`;
            messageEl.innerHTML = `
                <div class="bubble">${msg.text}</div>
                <div class="timestamp">${msg.time}</div>
            `;
            messagesDiv.appendChild(messageEl);
        });

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function selectUser(userId) {
        if (currentUserId === userId) return;
        document.querySelectorAll('#userList li').forEach(li => li.classList.remove('active'));
        document.querySelector(`#userList li[data-user-id="${userId}"]`).classList.add('active');
        currentUserId = userId;
        loadConversation(userId);
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if (!text) return;
        const time = new Date().toLocaleTimeString('vi', {hour: '2-digit', minute: '2-digit'});

        const msg = document.createElement('div');
        msg.className = 'message sent';
        msg.innerHTML = `<div class="bubble">${text}</div><div class="timestamp">${time}</div>`;
        document.getElementById('chatMessages').appendChild(msg);
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;

        conversations[currentUserId].messages.push({text, type: 'sent', time});
        saveToStorage();
        input.value = '';
        input.style.height = 'auto';

        // M√¥ ph·ªèng kh√°ch ph·∫£n h·ªìi
        showTyping();
        setTimeout(() => {
            hideTyping();
            const reply = getAutoReply();
            const replyTime = new Date().toLocaleTimeString('vi', {hour: '2-digit', minute: '2-digit'});
            addReceivedMessage(reply, replyTime);
            conversations[currentUserId].messages.push({text: reply, type: 'received', time: replyTime});
            saveToStorage();
        }, 1000 + Math.random() * 1000);
    }

    function showTyping() {
        document.getElementById('typingIndicator').style.display = 'flex';
    }
    function hideTyping() {
        document.getElementById('typingIndicator').style.display = 'none';
    }

    function addReceivedMessage(text, time) {
        const msg = document.createElement('div');
        msg.className = 'message received';
        msg.innerHTML = `<div class="bubble">${text}</div><div class="timestamp">${time}</div>`;
        const chat = document.getElementById('chatMessages');
        chat.appendChild(msg);
        chat.scrollTop = chat.scrollHeight;
    }

    function getAutoReply() {
        const replies = [
            "D·∫° v√¢ng, c·∫£m ∆°n shop ·∫°!",
            "Cho m√¨nh xin th√™m v√†i h√¨nh ·∫£nh th·ª±c t·∫ø nha.",
            "Tuy·ªát qu√°, c·∫£m ∆°n shop ƒë√£ t∆∞ v·∫•n!",
            "M√¨nh s·∫Ω gh√© mua th√™m v√†i b·ªô kh√°c sau nha üòä",
            "Shop ∆°i, m√¨nh ƒë·ªïi ƒë·ªãa ch·ªâ nh·∫≠n ƒë∆∞·ª£c kh√¥ng?"
        ];
        return replies[Math.floor(Math.random() * replies.length)];
    }


    document.getElementById('messageInput').addEventListener('keypress', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    const textarea = document.getElementById('messageInput');
    textarea.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadConversation(1);
    });

</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const current = window.location.pathname.split("/").pop();
        const links = document.querySelectorAll(".sidebar li a");

        links.forEach(link => {
            const linkPage = link.getAttribute("href");

            if (linkPage === current) {
                link.classList.add("active");
            }
        });
    });
</script>

</body>
</html>
