<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chat Người Mua - Người Bán</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="../css/adminCss/chatWithCus.css">

</head>
<body>

<!-- ==================== CHỈ CẬP NHẬT PHẦN NÀY ==================== -->
<div class="chat-container">
    <!-- Danh sách người dùng -->
    <div class="user-list">
        <div class="user-list-header">Tin nhắn</div>
        <ul id="userList">
            <li data-user-id="1" onclick="selectUser(1)" class="active">
                <img src="https://i.pravatar.cc/150?img=1" alt="User 1" class="user-avatar">
                <div class="user-info">
                    <div class="user-name">Người bán 1</div>
                    <div class="user-preview">Cảm ơn bạn đã mua hàng!</div>
                </div>
                <div class="user-status online"></div>
                <span class="unread-badge">2</span>
            </li>
            <li data-user-id="2" onclick="selectUser(2)">
                <img src="https://i.pravatar.cc/150?img=2" alt="User 2" class="user-avatar">
                <div class="user-info">
                    <div class="user-name">Người bán 2</div>
                    <div class="user-preview">Sản phẩm còn không ạ?</div>
                </div>
                <div class="user-status"></div>
            </li>
        </ul>
    </div>

    <!-- Khu vực chat -->
    <div class="chat-area">
        <div class="chat-header" id="chatHeader">
            <img src="https://i.pravatar.cc/150?img=1" alt="" class="user-avatar">
            <div class="header-info">
                <h3>Người bán 1</h3>
                <small><i class="fas fa-circle online-dot"></i> Đang hoạt động</small>
            </div>
            <button class="header-action"><i class="fas fa-ellipsis-v"></i></button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message received">
                <div class="bubble">Chào bạn! Mình có thể giúp gì ạ?</div>
                <div class="timestamp">10:32</div>
            </div>
            <div class="message sent">
                <div class="bubble">Mình cần tư vấn về sản phẩm</div>
                <div class="timestamp">10:33</div>
            </div>
        </div>

        <!-- Typing indicator -->
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <span></span><span></span><span></span>
        </div>

        <!-- Trong phần .chat-input -->
        <div class="chat-input">
            <label class="input-action" for="imageInput" title="Gửi ảnh">
                <i class="fas fa-image"></i>
            </label>
            <input type="file" id="imageInput" accept="image/*" style="display: none;"/>

            <textarea id="messageInput" placeholder="Nhập tin nhắn..." rows="1"></textarea>

            <button class="input-action emoji-btn"><i class="fas fa-smile"></i></button>
            <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>

        <!-- Xem trước ảnh -->
        <div id="imagePreview" class="image-preview" style="display: none;">
            <img id="previewImg" src="" alt="Preview"/>
            <button class="close-preview" onclick="closePreview()">×</button>
            <button class="send-image-btn" onclick="sendImage()">Gửi</button>
        </div>
    </div>
</div>
<!-- ============================================================ -->

<script>
    // === KEY LƯU TRỮ TRONG LOCALSTORAGE ===
    const STORAGE_KEY = 'comicstore_chat_history';

    // === LOAD DỮ LIỆU TỪ LOCALSTORAGE (nếu có) ===
    let conversations = {};
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            conversations = JSON.parse(saved);
        }
    } catch (e) {
        console.warn("Không thể đọc lịch sử chat:", e);
    }

    // === DỮ LIỆU MẶC ĐỊNH (nếu chưa có) ===
    const defaultConversations = {
        1: {
            user: {name: "Người bán 1", avatar: "https://i.pravatar.cc/150?img=1", online: true},
            messages: [
                {text: "Chào bạn! Mình có thể giúp gì ạ?", type: "received", time: "10:32"},
                {text: "Mình cần tư vấn về sản phẩm", type: "sent", time: "10:33"}
            ]
        },
        2: {
            user: {name: "Người bán 2", avatar: "https://i.pravatar.cc/150?img=2", online: false},
            messages: [
                {text: "Sản phẩm còn không ạ?", type: "sent", time: "09:15"},
                {text: "Dạ còn ạ, bạn muốn đặt hàng không?", type: "received", time: "09:16"}
            ]
        }
    };

    // Gộp dữ liệu mặc định nếu chưa tồn tại
    Object.keys(defaultConversations).forEach(id => {
        if (!conversations[id]) {
            conversations[id] = defaultConversations[id];
        }
    });

    let currentUserId = 1;

    // === LƯU VÀO LOCALSTORAGE ===
    function saveToStorage() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
        } catch (e) {
            console.warn("Không thể lưu lịch sử chat:", e);
        }
    }

    // === HIỂN THỊ HỘI THOẠI ===
    function loadConversation(userId) {
        const conv = conversations[userId];
        const header = document.getElementById('chatHeader');
        const messagesDiv = document.getElementById('chatMessages');

        // Cập nhật header
        header.innerHTML = `
            <img src="${conv.user.avatar}" alt="" class="user-avatar">
            <div class="header-info">
                <h3>${conv.user.name}</h3>
                <small><i class="fas fa-circle online-dot"></i> ${conv.user.online ? 'Đang hoạt động' : 'Offline'}</small>
            </div>
            <button class="header-action"><i class="fas fa-ellipsis-v"></i></button>
        `;

        // Load tin nhắn
        messagesDiv.innerHTML = '';
        conv.messages.forEach(msg => {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${msg.type}`;
            messageEl.innerHTML = `
                <div class="bubble">${msg.text}</div>
                <div class="timestamp">${msg.time}</div>
            `;
            messagesDiv.appendChild(messageEl);
        });

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // === CHỌN NGƯỜI BÁN ===
    function selectUser(userId) {
        if (currentUserId === userId) return;

        document.querySelectorAll('#userList li').forEach(li => li.classList.remove('active'));
        document.querySelector(`#userList li[data-user-id="${userId}"]`).classList.add('active');

        currentUserId = userId;
        loadConversation(userId);
    }

    // === GỬI TIN NHẮN ===
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if (!text) return;

        const time = new Date().toLocaleTimeString('vi', {hour: '2-digit', minute: '2-digit'});

        // Thêm tin nhắn gửi
        const messagesDiv = document.getElementById('chatMessages');
        const msg = document.createElement('div');
        msg.className = 'message sent';
        msg.innerHTML = `<div class="bubble">${text}</div><div class="timestamp">${time}</div>`;
        messagesDiv.appendChild(msg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Lưu vào dữ liệu + localStorage
        conversations[currentUserId].messages.push({text, type: 'sent', time});
        saveToStorage();

        input.value = '';
        input.style.height = 'auto';

        // Typing + phản hồi
        showTyping();
        setTimeout(() => {
            hideTyping();
            const reply = getAutoReply();
            const replyTime = new Date().toLocaleTimeString('vi', {hour: '2-digit', minute: '2-digit'});
            addReceivedMessage(reply, replyTime);

            // Lưu phản hồi
            conversations[currentUserId].messages.push({text: reply, type: 'received', time: replyTime});
            saveToStorage();
        }, 1000 + Math.random() * 1000);
    }

    // === HIỆU ỨNG TYPING ===
    function showTyping() {
        const typing = document.getElementById('typingIndicator');
        typing.style.display = 'flex';
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    }

    function hideTyping() {
        document.getElementById('typingIndicator').style.display = 'none';
    }

    // === THÊM TIN NHẬN ===
    function addReceivedMessage(text, time) {
        const messagesDiv = document.getElementById('chatMessages');
        const msg = document.createElement('div');
        msg.className = 'message received';
        msg.innerHTML = `<div class="bubble">${text}</div><div class="timestamp">${time}</div>`;
        messagesDiv.appendChild(msg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // === PHẢN HỒI TỰ ĐỘNG ===
    function getAutoReply() {
        const replies = [
            "Cảm ơn bạn! Mình đang kiểm tra giúp bạn nhé!",
            "Sản phẩm đang có sẵn ạ, bạn cần size nào?",
            "Mình sẽ gửi hình ảnh chi tiết ngay!",
            "Bạn muốn đặt hàng luôn không ạ?",
            "Đã nhận được yêu cầu, mình xử lý ngay!"
        ];
        return replies[Math.floor(Math.random() * replies.length)];
    }

    // === ENTER GỬI TIN ===
    document.getElementById('messageInput').addEventListener('keypress', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // === TỰ ĐỘNG RESIZE ===
    const textarea = document.getElementById('messageInput');
    textarea.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // === KHỞI TẠO ===
    document.addEventListener('DOMContentLoaded', () => {
        loadConversation(1);
    });
</script>
</body>
</html>