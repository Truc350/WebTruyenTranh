<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Profile</title>
    <link rel="stylesheet" href="../css/adminCss/styleProfile.css">
    <link rel="stylesheet" href="../css/adminCss/styleSidebar.css">
    <link rel="stylesheet" href="../css/adminCss/adminHeader.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>


<div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="../../img/logo.png" alt="Logo" class="logo">
            <h2>Comic Store</h2>
        </div>

        <ul>
            <li>
                <a href="dashboard.html">
                    <img src="../../img/home.png" class="icon">
                    <span>Trang chủ</span>
                </a>
            </li>
            <li>
                <a href="productManagement.html">
                    <img src="../../img/product.png" class="icon">
                    <span>Quản lý sản phẩm</span>
                </a>
            </li>
            <li>
                <a href="category.html">
                    <img src="../../img/category.png" class="icon">
                    <span>Quản lý thể loại</span>
                </a>
            </li>
            <li>
                <a href="order.html">
                    <img src="../../img/order.png" class="icon">
                    <span>Quản lý đơn hàng</span>
                </a>
            </li>
            <li>
                <a href="userManagement.html">
                    <img src="../../img/user.png" class="icon">
                    <span>Quản lý người dùng</span>
                </a>
            </li>
            <li>
                <a href="promotion.html">
                    <img src="../../img/promo.png" class="icon">
                    <span>Khuyến mãi</span>
                </a>
            </li>
            <li>
                <a href="report.html">
                    <img src="../../img/report.png" class="icon">
                    <span>Thống kê</span>
                </a>
            </li>
        </ul>
    </aside>

    <div class="main-content">
        <header class="admin-header">
            <div class="header-right">
                <a href="chatWithCus.html">
                    <i class="fa-solid fa-comment"></i>
                </a>

                <div class="admin-profile">
                    <img src="../../img/admin.png" class="admin-avatar" alt="Admin">
                    <span class="admin-name">Admin</span>
                </div>
            </div>
        </header>

        <!-- profile page (simple) -->
        <div class="profile-page">
            <!-- LEFT SIDE -->
            <div class="profile-left">
                <div class="avatar-box">
                    <img src="/path/to/avatar.jpg" alt="Avatar" class="avatar-lg">
                    <button id="btn-change-avatar" class="btn small">Đổi ảnh</button>
                </div>
                <h3>Trâm Trần</h3>
                <p class="role">Admin & Người bán</p>
            </div>

            <!-- RIGHT SIDE -->
            <div class="profile-right">
                <!-- Thông tin cơ bản -->
                <h4>Thông tin cơ bản</h4>
                <form id="profileForm">
                    <label>Họ tên
                        <input name="fullname" value="Nguyễn Ngọc Linh">
                    </label>
                    <label>Email
                        <input type="email" name="email" value="tramtran@example.com">
                    </label>
                    <label>Số điện thoại
                        <input name="phone" value="0123456789">
                    </label>
                    <label>Tên cửa hàng
                        <input name="storeName" value="Comic Store">
                    </label>
                    <label>Mã cửa hàng
                        <input name="storeId" value="CS001" readonly>
                    </label>
                    <div class="actions">
                        <button type="submit" class="btn">Lưu thay đổi</button>
                    </div>
                </form>

                <hr>

                <!-- Thông tin thanh toán -->
                <h4>Thông tin thanh toán / Ngân hàng</h4>

                <!-- Hiển thị Bản đọc (masked) -->
                <div class="bank-info" id="bankView">
                    <p><strong>Ngân hàng:</strong> <span id="bankNameText">Vietcombank</span></p>
                    <p><strong>Số tài khoản:</strong> <span id="acctMasked">**** **** 1234</span> <button id="btn-edit-bank" class="btn small inline">Chỉnh sửa</button></p>
                    <p><strong>Chủ tài khoản:</strong> <span id="acctNameText">Trâm Trần</span></p>
                    <p class="muted">* Bạn có thể chỉnh sửa thông tin thanh toán nếu cần.</p>
                </div>

                <!-- Form chỉnh sửa (ẩn ban đầu) -->
                <div class="bank-info-edit hidden" id="bankEdit">
                    <form id="bankForm">
                        <label>Ngân hàng
                            <input name="bankName" id="bankName" value="Vietcombank" required>
                        </label>
                        <label>Số tài khoản
                            <div style="display:flex; gap:8px; align-items:center;">
                                <input name="accountNumber" id="accountNumber" value="12341234" required style="flex:1">
                                <button type="button" id="btnToggleMask" class="btn small inline" title="Hiện/Mã hóa">Hiện</button>
                            </div>
                        </label>
                        <label>Chủ tài khoản
                            <input name="accountHolder" id="accountHolder" value="Trâm Trần" required>
                        </label>

                        <div class="actions" style="margin-top:8px;">
                            <button type="submit" class="btn">Lưu</button>
                            <button type="button" id="btnCancelBank" class="btn btn-secondary">Hủy</button>
                        </div>
                        <p id="bankMsg" class="muted" style="margin-top:8px"></p>
                    </form>
                </div>

                <hr>

                <!-- Lịch sử hoạt động -->
                <h4>Lịch sử hoạt động gần đây</h4>
                <div class="activity-log">
                    <table>
                        <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Hoạt động</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>12/11/2025 10:32</td>
                            <td>Đăng nhập vào hệ thống</td>
                        </tr>
                        <tr>
                            <td>11/11/2025 15:20</td>
                            <td>Chỉnh sửa khuyến mãi “Sale 11.11”</td>
                        </tr>
                        <tr>
                            <td>10/11/2025 09:10</td>
                            <td>Duyệt đơn hàng #DH0052</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <hr>

                <!-- Đổi mật khẩu -->
                <h4>Đổi mật khẩu</h4>
                <form id="changePassForm">
                    <label>Mật khẩu cũ
                        <input type="password" name="oldPassword" required>
                    </label>
                    <label>Mật khẩu mới
                        <input type="password" name="newPassword" required minlength="8">
                    </label>
                    <label>Xác nhận mật khẩu
                        <input type="password" name="confirmPassword" required>
                    </label>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary">Đổi mật khẩu</button>
                    </div>
                    <p id="passMsg" class="muted"></p>
                </form>
            </div>
        </div>


    </div>
</div>

<script>
    (function(){
        // Elements
        const bankView = document.getElementById('bankView');
        const bankEdit = document.getElementById('bankEdit');
        const btnEdit = document.getElementById('btn-edit-bank');
        const btnCancel = document.getElementById('btnCancelBank');
        const bankForm = document.getElementById('bankForm');
        const acctMasked = document.getElementById('acctMasked');
        const bankNameText = document.getElementById('bankNameText');
        const acctNameText = document.getElementById('acctNameText');

        const bankNameInput = document.getElementById('bankName');
        const accountNumberInput = document.getElementById('accountNumber');
        const accountHolderInput = document.getElementById('accountHolder');
        const btnToggleMask = document.getElementById('btnToggleMask');
        const bankMsg = document.getElementById('bankMsg');

        // initial actual account value: NOTE: in real app do NOT embed full account in HTML.
        // This is for demo. On real app fetch securely from server (e.g. via JS fetch).
        let actualAcct = accountNumberInput.value || '';
        let masked = true;

        function maskAccount(acct){
            // mask all but last 4 digits, group by 4 for readability
            const s = (acct || '').toString().replace(/\s+/g,'').replace(/[^0-9]/g,'');
            if(!s) return '----';
            const last4 = s.slice(-4);
            const maskedPart = s.slice(0, -4).replace(/\d/g,'*');
            // group by 4 with spaces
            const combined = maskedPart + last4;
            return combined.replace(/(.{4})/g,'$1 ').trim();
        }

        // initialize masked view
        acctMasked.textContent = maskAccount(actualAcct);

        // Toggle to edit mode
        btnEdit.addEventListener('click', () => {
            bankView.classList.add('hidden');
            bankEdit.classList.remove('hidden');
            // ensure inputs contain actual values
            bankNameInput.value = bankNameText.textContent.trim();
            accountNumberInput.value = actualAcct; // actual unmasked for editing
            accountHolderInput.value = acctNameText.textContent.trim();
            masked = false;
            btnToggleMask.textContent = 'Ẩn';
        });

        // Cancel edit
        btnCancel.addEventListener('click', () => {
            bankEdit.classList.add('hidden');
            bankView.classList.remove('hidden');
            bankMsg.textContent = '';
            // reset input values to actual (so subsequent edit shows unchanged)
            accountNumberInput.value = actualAcct;
        });

        // Toggle mask/show in edit
        btnToggleMask.addEventListener('click', () => {
            masked = !masked;
            if(masked){
                // show masked in input by replacing value with masked string and disable editing
                accountNumberInput.type = 'text';
                accountNumberInput.value = maskAccount(actualAcct);
                accountNumberInput.setAttribute('data-masked','1');
                btnToggleMask.textContent = 'Hiện';
            } else {
                // show raw, editable
                accountNumberInput.type = 'text';
                accountNumberInput.value = actualAcct;
                accountNumberInput.removeAttribute('data-masked');
                btnToggleMask.textContent = 'Ẩn';
                // focus for convenience
                accountNumberInput.focus();
            }
        });

        // When user edits account field while masked, unmask to allow editing
        accountNumberInput.addEventListener('input', (e) => {
            // if it was masked placeholder, and user starts typing, unmask the field
            if (accountNumberInput.getAttribute('data-masked')) {
                accountNumberInput.removeAttribute('data-masked');
            }
        });

        // Submit form (AJAX)
        bankForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            bankMsg.textContent = 'Đang lưu...';

            // get values; if field currently masked (data-masked), show error asking to unmask to verify
            let bankName = bankNameInput.value.trim();
            let acctNum = accountNumberInput.value.trim();
            const holder = accountHolderInput.value.trim();

            if(!bankName || !acctNum || !holder){
                bankMsg.textContent = 'Vui lòng điền đầy đủ thông tin.';
                return;
            }

            // If acct input currently contains masked characters, block and ask to unmask
            if(/[*]/.test(acctNum)){
                bankMsg.textContent = 'Vui lòng bấm "Hiện" để xem và chỉnh sửa số tài khoản trước khi lưu.';
                return;
            }

            // Optional: basic validation (digits only, length check)
            const cleaned = acctNum.replace(/\s+/g,'').replace(/[^0-9]/g,'');
            if(cleaned.length < 6){
                bankMsg.textContent = 'Số tài khoản có vẻ không hợp lệ.';
                return;
            }

            try {
                // send to backend (adjust URL & payload as needed)
                const res = await fetch('/api/admin/update-bank', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        bankName, accountNumber: cleaned, accountHolder: holder
                    })
                });

                if (!res.ok) {
                    const err = await res.json().catch(()=>({message:'Lỗi server'}));
                    bankMsg.textContent = err.message || 'Lưu thất bại';
                    return;
                }

                const data = await res.json();
                // assume backend returns success and maybe maskedAcct to display
                actualAcct = cleaned;
                bankNameText.textContent = bankName;
                acctNameText.textContent = holder;
                acctMasked.textContent = maskAccount(actualAcct);

                bankMsg.textContent = 'Lưu thành công.';
                // switch back to view
                setTimeout(() => {
                    bankEdit.classList.add('hidden');
                    bankView.classList.remove('hidden');
                    bankMsg.textContent = '';
                }, 900);

            } catch (err) {
                bankMsg.textContent = 'Có lỗi xảy ra. Vui lòng thử lại.';
                console.error(err);
            }
        });

    })();
</script>

</body>
</html>